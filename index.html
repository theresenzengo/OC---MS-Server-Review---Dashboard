<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Microsoft Licensing Tracker - Oetker Collection</title>
  
  <!-- PWA Meta Tags -->
  <meta name="theme-color" content="#1a1a2e">
  <meta name="description" content="Microsoft Server Licensing Tracker for Oetker Collection - SAM Dashboard">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="MS Licensing">
  <link rel="manifest" href="manifest.json">
  <link rel="apple-touch-icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><rect fill='%231a1a2e' width='100' height='100' rx='20'/><circle cx='30' cy='30' r='12' fill='%23E87A2A'/><circle cx='50' cy='22' r='18' fill='%23E87A2A'/><circle cx='30' cy='60' r='18' fill='%23E87A2A'/><circle cx='50' cy='75' r='12' fill='%23E87A2A'/><circle cx='22' cy='78' r='8' fill='%23E87A2A'/></svg>">
  
  <script src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Space+Mono:wght@400;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg-page: linear-gradient(160deg, #1a1a2e 0%, #1a2744 40%, #16213e 70%, #1a1a2e 100%);
      --text-primary: #1a1a2e;
      --text-secondary: #5a5a6e;
      --text-muted: #8a8a9a;
      --text-light: #ffffff;
      --accent-orange: #E87A2A;
      --accent-orange-light: #F5923D;
      --accent-orange-bg: rgba(232, 122, 42, 0.1);
      --accent-green: #10b981;
      --accent-green-bg: rgba(16, 185, 129, 0.1);
      --accent-yellow: #f59e0b;
      --accent-yellow-bg: rgba(245, 158, 11, 0.1);
      --accent-red: #ef4444;
      --accent-red-bg: rgba(239, 68, 68, 0.1);
      --accent-blue: #3b82f6;
      --accent-blue-bg: rgba(59, 130, 246, 0.1);
      --accent-purple: #8b5cf6;
      --accent-purple-bg: rgba(139, 92, 246, 0.1);
      --accent-cyan: #06b6d4;
      --accent-cyan-bg: rgba(6, 182, 212, 0.1);
      --accent-rose: #f43f5e;
      --accent-rose-bg: rgba(244, 63, 94, 0.1);
      --border-color: #c8c8d0;
      --shadow-sm: 0 2px 8px rgba(0,0,0,0.15);
      --shadow-md: 0 4px 20px rgba(0,0,0,0.25);
      --gradient-header: linear-gradient(135deg, #1a1a2e 0%, #1e3a5f 40%, #3b82f6 100%);
      --gradient-card: linear-gradient(180deg, #e5e5eb 0%, #c8c8d0 100%);
      --gradient-orange: linear-gradient(135deg, #E87A2A 0%, #F5923D 100%);
      --card-dark: linear-gradient(135deg, rgba(30, 41, 59, 0.95) 0%, rgba(15, 23, 42, 0.95) 100%);
    }
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: 'DM Sans', sans-serif; background: var(--bg-page); color: var(--text-light); min-height: 100vh; }
    .app-container { max-width: 1600px; margin: 0 auto; padding: 2rem; padding-top: 1rem; }
    
    /* Header - Sticky */
    .header-wrapper {
      position: sticky;
      top: 1rem;
      z-index: 50;
      margin-bottom: 2rem;
    }
    .header { 
      display: flex; 
      justify-content: space-between; 
      align-items: center; 
      padding: 1rem 2rem; 
      background: var(--gradient-header); 
      border-radius: 16px;
      box-shadow: var(--shadow-md); 
    }
    .logo-section { display: flex; align-items: center; gap: 1.5rem; }
    .logo-img { height: 40px; width: auto; }
    .logo-text h1 { font-size: 1.4rem; font-weight: 700; color: var(--text-light); }
    .logo-text span { font-size: 0.85rem; color: rgba(255,255,255,0.7); }
    .header-right { display: flex; align-items: center; gap: 1.5rem; }
    .section-header-spacer { flex: 1; }
    .export-btn {
      background: transparent;
      border: 1px solid rgba(232, 122, 42, 0.4);
      color: #E87A2A;
      width: 150px;
      padding: 0.3rem 0.6rem;
      border-radius: 8px;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.75rem;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s ease;
      text-align: center;
    }
    .export-btn:hover {
      background: rgba(232, 122, 42, 0.1);
      border-color: #E87A2A;
    }
    .export-btn.disabled {
      opacity: 0.4;
      cursor: not-allowed;
      border-color: rgba(150, 150, 150, 0.3);
      color: #999;
    }
    .export-btn.disabled:hover {
      background: transparent;
      border-color: rgba(150, 150, 150, 0.3);
    }
    .last-update { font-family: 'Space Mono', monospace; font-size: 0.75rem; color: rgba(255,255,255,0.6); }
    .loading-indicator { display: flex; align-items: center; gap: 0.5rem; font-size: 0.8rem; color: var(--accent-orange); margin-top: 0.25rem; }
    .loading-dot { width: 8px; height: 8px; background: var(--accent-orange); border-radius: 50%; animation: pulse 1.5s infinite; }
    @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.4; } }
    
    /* Subsidiary Filter */
    .subsidiary-filter {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      background: rgba(255,255,255,0.1);
      padding: 0.5rem 1rem;
      border-radius: 10px;
      border: 1px solid rgba(255,255,255,0.2);
    }
    .subsidiary-filter label {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.7);
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }
    .subsidiary-filter select {
      background: transparent;
      border: none;
      color: white;
      font-family: 'DM Sans', sans-serif;
      font-size: 0.9rem;
      font-weight: 600;
      cursor: pointer;
      padding-right: 1rem;
    }
    .subsidiary-filter select option { background: #1a1a2e; color: white; }
    .subsidiary-filter select:focus { outline: none; }
    
    /* KPI Grid - 5 cards */
    .kpi-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 1rem; margin-bottom: 1.5rem; }
    @media (max-width: 1200px) { .kpi-grid { grid-template-columns: repeat(3, 1fr); } }
    @media (max-width: 768px) { .kpi-grid { grid-template-columns: repeat(2, 1fr); } }
    .kpi-card { 
      background: var(--gradient-card); 
      border-radius: 12px; 
      padding: 1.25rem; 
      position: relative; 
      box-shadow: var(--shadow-sm); 
      overflow: hidden; 
    }
    .kpi-card::before { content: ''; position: absolute; top: 0; left: 0; right: 0; height: 4px; background: var(--gradient-orange); }
    .kpi-card.green::before { background: var(--accent-green); }
    .kpi-card.yellow::before { background: var(--accent-yellow); }
    .kpi-card.red::before { background: var(--accent-red); }
    .kpi-label { font-size: 0.75rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 0.5rem; }
    .kpi-value { font-size: 2rem; font-weight: 700; font-family: 'Space Mono', monospace; color: var(--text-primary); }
    .kpi-subtitle { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem; }
    
    /* Main License Section */
    .license-section {
      margin-bottom: 2rem;
    }
    @media (max-width: 1100px) { 
      .license-section { 
        margin-bottom: 1.5rem;
      }
    }
    
    /* Compliance Bars */
    .compliance-panel {
      display: flex;
      flex-direction: column;
    }
    
    /* Section Title */
    .section-header {
      display: flex;
      align-items: center;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
      padding-bottom: 0.75rem;
      border-bottom: 1px solid rgba(255,255,255,0.15);
    }
    .section-title {
      font-size: 0.85rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: rgba(255,255,255,0.7);
    }
    .estimated-label {
      font-size: 0.75rem;
      font-weight: 500;
      color: #E87A2A;
      font-style: italic;
    }
    .pending-badge {
      font-size: 0.7rem;
      font-weight: 500;
      color: #fbbf24;
      background: rgba(251, 191, 36, 0.15);
      border: 1px solid rgba(251, 191, 36, 0.3);
      padding: 0.25rem 0.6rem;
      border-radius: 20px;
      animation: pulse-pending 2s ease-in-out infinite;
    }
    @keyframes pulse-pending {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.6; }
    }
    .na-badge {
      font-size: 0.7rem;
      font-weight: 500;
      color: #94a3b8;
      background: rgba(100, 116, 139, 0.15);
      border: 1px solid rgba(100, 116, 139, 0.3);
      padding: 0.25rem 0.6rem;
      border-radius: 20px;
    }
    .surplus-badge {
      font-size: 0.7rem;
      font-weight: 500;
      color: #34d399;
      background: rgba(16, 185, 129, 0.15);
      border: 1px solid rgba(16, 185, 129, 0.3);
      padding: 0.25rem 0.6rem;
      border-radius: 20px;
    }
    
    /* EOS Warning Badge */
    .eos-badge {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.2) 0%, rgba(245, 158, 11, 0.15) 100%);
      border: 1px solid rgba(251, 191, 36, 0.4);
      border-radius: 10px;
      padding: 0.6rem 1rem;
      cursor: pointer;
      transition: all 0.2s ease;
    }
    .eos-badge:hover {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.3) 0%, rgba(245, 158, 11, 0.25) 100%);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(251, 191, 36, 0.2);
    }
    .eos-badge-icon {
      font-size: 1.1rem;
    }
    .eos-badge-text {
      font-size: 0.8rem;
      font-weight: 600;
      color: #fbbf24;
    }
    .eos-badge-count {
      font-family: 'Space Mono', monospace;
      font-size: 0.85rem;
      font-weight: 700;
      color: #fcd34d;
      background: rgba(0,0,0,0.2);
      padding: 0.2rem 0.5rem;
      border-radius: 6px;
    }
    .compliance-bars {
      display: flex;
      flex-direction: column;
      gap: 1rem;
      flex: 1;
    }
    .compliance-row {
      display: flex;
      gap: 1rem;
      align-items: stretch;
    }
    .compliance-bar-item {
      background: var(--card-dark);
      border-radius: 12px;
      padding: 1rem 1.25rem;
      border: 1px solid rgba(255,255,255,0.08);
      flex: 1;
    }
    
    /* License Recommendation Card */
    .license-rec-card {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.15) 0%, rgba(220, 38, 38, 0.1) 100%);
      border: 1px solid rgba(239, 68, 68, 0.3);
      border-radius: 12px;
      padding: 0.75rem 1rem;
      width: 150px;
      min-width: 150px;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
    }
    .license-rec-card.compliant {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.1) 100%);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    .license-rec-card.pending {
      background: linear-gradient(135deg, rgba(251, 191, 36, 0.15) 0%, rgba(245, 158, 11, 0.1) 100%);
      border: 1px solid rgba(251, 191, 36, 0.3);
    }
    .license-rec-card.pending .license-rec-check {
      color: #fbbf24;
    }
    .license-rec-card.pending .license-rec-status {
      color: #fbbf24;
    }
    .license-rec-card.na {
      background: linear-gradient(135deg, rgba(100, 116, 139, 0.15) 0%, rgba(71, 85, 105, 0.1) 100%);
      border: 1px solid rgba(100, 116, 139, 0.3);
    }
    .license-rec-card.na .license-rec-check {
      color: #94a3b8;
      font-size: 1.8rem;
    }
    .license-rec-card.na .license-rec-status {
      color: #94a3b8;
    }
    .license-rec-card.surplus {
      background: linear-gradient(135deg, rgba(16, 185, 129, 0.15) 0%, rgba(5, 150, 105, 0.1) 100%);
      border: 1px solid rgba(16, 185, 129, 0.3);
    }
    .license-rec-card.surplus .license-rec-check {
      font-size: 1.2rem;
      margin-bottom: 0.1rem;
    }
    .license-rec-card.surplus .license-rec-status {
      color: #34d399;
      font-size: 0.65rem;
    }
    .license-rec-surplus {
      font-family: 'Space Mono', monospace;
      font-size: 0.85rem;
      font-weight: 700;
      color: #34d399;
      margin-top: 0.2rem;
    }
    .license-rec-header {
      display: flex;
      align-items: center;
      gap: 0.35rem;
      margin-bottom: 0.35rem;
    }
    .license-rec-icon {
      font-size: 0.85rem;
    }
    .license-rec-title {
      font-size: 0.65rem;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #fca5a5;
    }
    .license-rec-value {
      font-size: 1.5rem;
      font-weight: 700;
      font-family: 'Space Mono', monospace;
      color: #fca5a5;
      line-height: 1;
    }
    .license-rec-sku {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.6);
      margin-top: 0.35rem;
      line-height: 1.3;
    }
    .license-rec-check {
      font-size: 1.5rem;
      color: #34d399;
      margin-bottom: 0.25rem;
    }
    .license-rec-status {
      font-size: 0.7rem;
      font-weight: 600;
      text-transform: uppercase;
      color: #34d399;
    }
    .license-rec-renew {
      font-family: 'Space Mono', monospace;
      font-size: 0.8rem;
      font-weight: 600;
      color: white;
      margin-top: 0.3rem;
    }
    .license-rec-saving {
      font-family: 'Space Mono', monospace;
      font-size: 0.7rem;
      color: #34d399;
      margin-top: 0.1rem;
    }
    @media (max-width: 900px) {
      .compliance-row {
        flex-direction: column;
      }
      .license-rec-card {
        min-width: 100%;
        flex-direction: row;
        justify-content: space-between;
        padding: 0.75rem 1rem;
      }
      .license-rec-header {
        margin-bottom: 0;
      }
      .license-rec-value {
        font-size: 1.2rem;
      }
    }
    .compliance-bar-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 0.5rem;
    }
    .compliance-bar-label {
      font-size: 0.8rem;
      font-weight: 600;
      color: rgba(255,255,255,0.9);
      display: flex;
      align-items: center;
      gap: 0.5rem;
    }
    .compliance-bar-metric {
      font-size: 0.65rem;
      color: rgba(255,255,255,0.5);
      background: rgba(255,255,255,0.1);
      padding: 0.15rem 0.4rem;
      border-radius: 4px;
    }
    .compliance-bar-values {
      font-size: 0.8rem;
      font-family: 'Space Mono', monospace;
      color: rgba(255,255,255,0.7);
    }
    .compliance-bar-values .required { color: var(--accent-orange); font-weight: 600; }
    .compliance-bar-values .entitled { color: rgba(255,255,255,0.5); }
    .compliance-bar-container {
      height: 24px;
      background: rgba(255,255,255,0.1);
      border-radius: 6px;
      overflow: hidden;
      position: relative;
    }
    .compliance-bar-fill {
      height: 100%;
      border-radius: 6px;
      transition: width 0.5s ease;
      position: relative;
    }
    .compliance-bar-fill.compliant {
      background: linear-gradient(90deg, #10b981, #34d399);
    }
    .compliance-bar-fill.warning {
      background: linear-gradient(90deg, #f59e0b, #fbbf24);
    }
    .compliance-bar-fill.over {
      background: repeating-linear-gradient(
        90deg,
        #ef4444 0%,
        #f87171 50%,
        #ef4444 100%
      );
      animation: pulse-bar 2s ease-in-out infinite;
    }
    @keyframes pulse-bar {
      0%, 100% { opacity: 1; }
      50% { opacity: 0.8; }
    }
    .compliance-bar-marker {
      position: absolute;
      top: -4px;
      bottom: -4px;
      width: 3px;
      background: white;
      border-radius: 2px;
      box-shadow: 0 0 4px rgba(0,0,0,0.5);
    }
    .compliance-bar-footer {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-top: 0.5rem;
    }
    .compliance-percentage {
      font-size: 0.85rem;
      font-weight: 700;
      font-family: 'Space Mono', monospace;
    }
    .compliance-percentage.compliant { color: #10b981; }
    .compliance-percentage.warning { color: #f59e0b; }
    .compliance-percentage.over { color: #ef4444; }
    .compliance-gap {
      font-size: 0.75rem;
      font-family: 'Space Mono', monospace;
      padding: 0.2rem 0.5rem;
      border-radius: 4px;
    }
    .compliance-gap.surplus { background: var(--accent-green-bg); color: #10b981; }
    .compliance-gap.deficit { background: var(--accent-red-bg); color: #ef4444; }
    
    /* No Data State */
    .no-data-state {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 3rem;
      color: rgba(255,255,255,0.4);
      text-align: center;
    }
    .no-data-icon {
      font-size: 3rem;
      margin-bottom: 1rem;
    }
    .no-data-text {
      font-size: 1rem;
      margin-bottom: 0.5rem;
    }
    .no-data-subtext {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.3);
    }
    
    /* EOS Modal */
    .eos-modal {
      background: linear-gradient(135deg, #2d2a1a 0%, #1a1a2e 100%);
      border-radius: 16px;
      padding: 1.5rem;
      max-width: 450px;
      width: 100%;
      border: 1px solid rgba(251, 191, 36, 0.3);
    }
    .eos-modal-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 1.25rem;
      padding-bottom: 1rem;
      border-bottom: 1px solid rgba(251, 191, 36, 0.2);
    }
    .eos-modal-title {
      display: flex;
      align-items: center;
      gap: 0.5rem;
      font-size: 1rem;
      font-weight: 600;
      color: #fbbf24;
    }
    .eos-modal-close {
      background: rgba(255,255,255,0.1);
      border: none;
      color: rgba(255,255,255,0.6);
      width: 32px;
      height: 32px;
      border-radius: 8px;
      cursor: pointer;
      font-size: 1.1rem;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: all 0.2s;
    }
    .eos-modal-close:hover {
      background: rgba(255,255,255,0.2);
      color: white;
    }
    .eos-modal-value {
      font-size: 2.5rem;
      font-weight: 700;
      font-family: 'Space Mono', monospace;
      color: #fcd34d;
      margin-bottom: 0.25rem;
    }
    .eos-modal-label {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.6);
      margin-bottom: 1.25rem;
    }
    .eos-modal-breakdown {
      display: flex;
      flex-direction: column;
      gap: 0.75rem;
      margin-bottom: 1.25rem;
    }
    .eos-modal-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      background: rgba(255,255,255,0.05);
      padding: 0.75rem 1rem;
      border-radius: 8px;
    }
    .eos-modal-item-left {
      display: flex;
      align-items: center;
      gap: 0.75rem;
    }
    .eos-modal-dot {
      width: 12px;
      height: 12px;
      border-radius: 3px;
    }
    .eos-modal-dot.critical { background: #ef4444; }
    .eos-modal-dot.high { background: #f97316; }
    .eos-modal-dot.medium { background: #eab308; }
    .eos-modal-item-label {
      font-size: 0.9rem;
      color: rgba(255,255,255,0.8);
    }
    .eos-modal-item-count {
      font-family: 'Space Mono', monospace;
      font-size: 1rem;
      font-weight: 700;
      color: white;
    }
    .eos-modal-affected {
      font-size: 0.8rem;
      color: rgba(255,255,255,0.5);
      font-style: italic;
      padding-top: 0.75rem;
      border-top: 1px solid rgba(255,255,255,0.1);
    }
    
    /* Entitlements Modal */
    .entitlements-modal {
      background: linear-gradient(160deg, #1e3a5f 0%, #1a2744 50%, #1a1a2e 100%);
      border-radius: 16px;
      padding: 1.5rem;
      max-width: 700px;
      width: 95%;
      max-height: 80vh;
      overflow-y: auto;
      border: 1px solid rgba(59, 130, 246, 0.3);
      box-shadow: 0 25px 50px rgba(0,0,0,0.5);
    }
    .entitlements-table-wrapper {
      overflow-x: auto;
      margin: 1rem 0;
    }
    .entitlements-table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }
    .entitlements-table th {
      background: rgba(255,255,255,0.1);
      color: rgba(255,255,255,0.7);
      font-weight: 600;
      text-transform: uppercase;
      font-size: 0.7rem;
      letter-spacing: 0.05em;
      padding: 0.75rem 0.5rem;
      text-align: right;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }
    .entitlements-table th:first-child {
      text-align: left;
      padding-left: 1rem;
    }
    .entitlements-table td {
      padding: 0.75rem 0.5rem;
      text-align: right;
      color: rgba(255,255,255,0.8);
      font-family: 'Space Mono', monospace;
      border-bottom: 1px solid rgba(255,255,255,0.05);
    }
    .entitlements-table td.sub-name {
      text-align: left;
      padding-left: 1rem;
      font-family: 'DM Sans', sans-serif;
      font-weight: 500;
      color: white;
    }
    .entitlements-table tbody tr:hover {
      background: rgba(255,255,255,0.05);
    }
    .entitlements-table tfoot tr {
      background: rgba(232, 122, 42, 0.15);
      border-top: 2px solid rgba(232, 122, 42, 0.3);
    }
    .entitlements-table tfoot td {
      font-weight: 700;
      color: #E87A2A;
    }
    .entitlements-table tfoot td.sub-name {
      color: #E87A2A;
    }
    .entitlements-note {
      font-size: 0.75rem;
      color: rgba(255,255,255,0.4);
      font-style: italic;
      margin-top: 0.5rem;
    }
    
    /* Tabs & Search */
    .tabs-container { 
      background: var(--gradient-card); 
      border-radius: 12px; 
      padding: 0.5rem; 
      margin-bottom: 1.5rem; 
      box-shadow: var(--shadow-sm); 
      display: inline-flex; 
      gap: 0.25rem; 
    }
    .tab { background: transparent; border: none; color: var(--text-secondary); padding: 0.6rem 1.2rem; border-radius: 8px; cursor: pointer; font-family: 'DM Sans', sans-serif; font-size: 0.9rem; font-weight: 500; transition: all 0.2s ease; }
    .tab:hover { color: var(--text-primary); background: rgba(255,255,255,0.5); }
    .tab.active { color: white; background: var(--accent-orange); }
    .filter-bar { display: flex; gap: 1rem; margin-bottom: 1.5rem; flex-wrap: wrap; align-items: center; }
    .search-input { 
      background: var(--gradient-card); 
      border: none; 
      color: var(--text-primary); 
      padding: 0.75rem 1rem; 
      border-radius: 10px; 
      font-family: 'DM Sans', sans-serif; 
      font-size: 0.9rem; 
      flex: 1; 
      min-width: 200px; 
      box-shadow: var(--shadow-sm); 
    }
    .search-input::placeholder { color: var(--text-muted); }
    .search-input:focus { outline: none; box-shadow: 0 0 0 3px var(--accent-orange-bg), var(--shadow-sm); }
    
    /* BU Cards */
    .bu-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(380px, 1fr)); gap: 1.25rem; }
    .bu-card { 
      background: var(--gradient-card); 
      border-radius: 14px; 
      padding: 1.5rem; 
      cursor: pointer; 
      transition: all 0.2s ease; 
      position: relative; 
      box-shadow: var(--shadow-sm); 
    }
    .bu-card:hover { box-shadow: var(--shadow-md); transform: translateY(-3px); }
    .bu-card-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 1rem; }
    .bu-unit-badge { font-family: 'Space Mono', monospace; font-size: 0.7rem; background: var(--accent-orange-bg); color: var(--accent-orange); padding: 0.25rem 0.5rem; border-radius: 6px; font-weight: 600; }
    .bu-name { font-size: 1.15rem; font-weight: 600; margin: 0.5rem 0 0.25rem 0; color: var(--text-primary); }
    .bu-country { font-size: 0.85rem; color: var(--text-secondary); }
    .bu-subsidiary { font-size: 0.7rem; color: var(--text-muted); margin-top: 0.25rem; }
    .subsidiary-tag { display: inline-block; padding: 0.2rem 0.5rem; border-radius: 4px; font-size: 0.65rem; font-weight: 600; text-transform: uppercase; }
    .subsidiary-tag.martin-braun { background: var(--accent-blue-bg); color: var(--accent-blue); }
    .subsidiary-tag.budenheim { background: var(--accent-cyan-bg); color: var(--accent-cyan); }
    .subsidiary-tag.henkell-freixenet { background: var(--accent-purple-bg); color: var(--accent-purple); }
    .subsidiary-tag.oe-hotels { background: var(--accent-rose-bg); color: var(--accent-rose); }
    .bu-infra-summary { font-size: 0.8rem; color: var(--text-muted); margin-top: 0.5rem; font-style: italic; background: rgba(255,255,255,0.4); padding: 0.5rem 0.75rem; border-radius: 6px; }
    .status-badge { display: inline-flex; align-items: center; gap: 0.35rem; padding: 0.35rem 0.75rem; border-radius: 20px; font-size: 0.7rem; font-weight: 600; text-transform: uppercase; }
    .status-badge.complete { background: var(--accent-green-bg); color: var(--accent-green); }
    .status-badge.received { background: var(--accent-orange-bg); color: var(--accent-orange); }
    .status-badge.incomplete { background: var(--accent-yellow-bg); color: var(--accent-yellow); }
    .status-badge.pending { background: var(--accent-yellow-bg); color: var(--accent-yellow); }
    .status-badge.not-sent { background: var(--accent-red-bg); color: var(--accent-red); }
    .status-badge.out-of-scope { background: rgba(0,0,0,0.1); color: var(--text-muted); }
    .status-badge.no-data { background: rgba(0,0,0,0.1); color: var(--text-muted); }
    .status-dot { width: 6px; height: 6px; border-radius: 50%; background: currentColor; }
    .progress-section { margin: 1rem 0; }
    .progress-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 0.5rem; }
    .progress-label { font-size: 0.8rem; color: var(--text-secondary); }
    .progress-value { font-family: 'Space Mono', monospace; font-size: 0.85rem; font-weight: 700; color: var(--text-primary); }
    .progress-bar { height: 8px; background: rgba(0,0,0,0.1); border-radius: 4px; overflow: hidden; }
    .progress-fill { height: 100%; background: var(--gradient-orange); border-radius: 4px; }
    .license-summary { display: flex; gap: 0.5rem; margin: 1rem 0; flex-wrap: wrap; }
    .license-tag { display: inline-flex; align-items: center; gap: 0.3rem; padding: 0.3rem 0.6rem; border-radius: 6px; font-size: 0.75rem; font-weight: 600; font-family: 'Space Mono', monospace; }
    .license-tag.ws { background: var(--accent-blue-bg); color: var(--accent-blue); }
    .license-tag.sql { background: var(--accent-purple-bg); color: var(--accent-purple); }
    .license-tag.rds { background: var(--accent-green-bg); color: var(--accent-green); }
    .checklist-mini { display: flex; gap: 0.4rem; margin-top: 1rem; padding-top: 1rem; border-top: 1px solid var(--border-color); }
    .check-dot { width: 10px; height: 10px; border-radius: 50%; background: rgba(0,0,0,0.15); }
    .check-dot.done { background: var(--accent-green); }
    .priority-badge { position: absolute; top: 1rem; right: 1rem; font-size: 0.65rem; font-weight: 700; text-transform: uppercase; padding: 0.3rem 0.6rem; border-radius: 6px; }
    .priority-badge.critical { background: var(--accent-rose-bg); color: var(--accent-rose); }
    .priority-badge.high { background: var(--accent-red-bg); color: var(--accent-red); }
    .priority-badge.medium { background: var(--accent-yellow-bg); color: var(--accent-yellow); }
    .priority-badge.low { background: var(--accent-green-bg); color: var(--accent-green); }
    
    /* Modal */
    .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); display: flex; align-items: center; justify-content: center; z-index: 100; padding: 1rem; }
    .modal-content { background: linear-gradient(180deg, #e5e5eb 0%, #d0d0d8 100%); border-radius: 20px; width: 100%; max-width: 750px; max-height: 90vh; overflow-y: auto; box-shadow: 0 20px 60px rgba(0,0,0,0.4); }
    .modal-header { padding: 1.75rem; border-bottom: 1px solid var(--border-color); display: flex; justify-content: space-between; align-items: flex-start; background: linear-gradient(180deg, #d8d8e0 0%, #c8c8d0 100%); border-radius: 20px 20px 0 0; }
    .modal-close { background: rgba(255,255,255,0.8); border: 1px solid var(--border-color); color: var(--text-primary); width: 40px; height: 40px; border-radius: 10px; cursor: pointer; font-size: 1.25rem; display: flex; align-items: center; justify-content: center; }
    .modal-close:hover { background: var(--accent-red); border-color: var(--accent-red); color: white; }
    .modal-body { padding: 1.75rem; }
    .detail-section { margin-bottom: 1.75rem; }
    .detail-section h3 { font-size: 0.8rem; color: var(--text-secondary); text-transform: uppercase; letter-spacing: 0.05em; margin-bottom: 1rem; padding-bottom: 0.5rem; border-bottom: 2px solid var(--border-color); }
    .info-grid { display: grid; grid-template-columns: repeat(2, 1fr); gap: 1rem; }
    .info-item { background: rgba(255,255,255,0.5); padding: 1rem; border-radius: 10px; }
    .info-item.full-width { grid-column: span 2; }
    .info-label { font-size: 0.7rem; color: var(--text-muted); text-transform: uppercase; margin-bottom: 0.3rem; }
    .info-value { font-size: 0.95rem; font-weight: 600; color: var(--text-primary); }
    .info-value.infra { font-weight: 400; font-style: italic; color: var(--text-secondary); }
    .license-table { width: 100%; border-collapse: collapse; margin-top: 0.5rem; background: rgba(255,255,255,0.4); border-radius: 10px; overflow: hidden; }
    .license-table th, .license-table td { padding: 0.75rem 1rem; text-align: left; border-bottom: 1px solid var(--border-color); }
    .license-table th { background: rgba(255,255,255,0.5); font-size: 0.75rem; font-weight: 600; color: var(--text-secondary); text-transform: uppercase; }
    .license-table td { font-size: 0.9rem; color: var(--text-primary); }
    .license-table tr:last-child td { border-bottom: none; }
    .license-table .product-cell { display: flex; align-items: center; gap: 0.5rem; }
    .license-table .product-icon { width: 28px; height: 28px; border-radius: 6px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: 700; }
    .license-table .product-icon.ws { background: var(--accent-blue-bg); color: var(--accent-blue); }
    .license-table .product-icon.sql { background: var(--accent-purple-bg); color: var(--accent-purple); }
    .license-table .product-icon.rds { background: var(--accent-green-bg); color: var(--accent-green); }
    .license-table .value-cell { font-family: 'Space Mono', monospace; font-weight: 600; }
    .license-table .required-cell { font-family: 'Space Mono', monospace; color: var(--accent-orange); font-weight: 600; }
    .alert-box { background: var(--accent-red-bg); border-left: 4px solid var(--accent-red); border-radius: 8px; padding: 1rem; margin-bottom: 1rem; }
    .alert-box.warning { background: var(--accent-yellow-bg); border-left-color: var(--accent-yellow); }
    .alert-title { font-size: 0.85rem; font-weight: 700; color: var(--accent-red); margin-bottom: 0.4rem; }
    .alert-box.warning .alert-title { color: var(--accent-yellow); }
    .alert-content { font-size: 0.85rem; color: var(--text-secondary); line-height: 1.6; }
    .checklist-full { display: grid; gap: 0.6rem; }
    .checklist-item { display: flex; align-items: center; gap: 0.75rem; padding: 0.75rem 1rem; background: rgba(255,255,255,0.5); border-radius: 8px; }
    .checklist-checkbox { width: 22px; height: 22px; border-radius: 50%; border: 2px solid var(--border-color); display: flex; align-items: center; justify-content: center; flex-shrink: 0; }
    .checklist-checkbox.checked { background: var(--accent-green); border-color: var(--accent-green); }
    .checklist-checkbox.checked::after { content: 'âœ“'; color: white; font-size: 0.75rem; font-weight: bold; }
    .checklist-text { font-size: 0.9rem; color: var(--text-primary); }
    .checklist-text.done { color: var(--text-muted); text-decoration: line-through; }
    .no-data { color: var(--text-muted); font-style: italic; font-size: 0.8rem; }
    
    @media (max-width: 768px) { 
      .app-container { padding: 1rem; } 
      .header { flex-direction: column; gap: 1rem; padding: 1.25rem; } 
      .header-right { flex-direction: column; align-items: flex-start; gap: 0.75rem; width: 100%; }
      .subsidiary-filter { width: 100%; }
      .kpi-grid { grid-template-columns: repeat(2, 1fr); gap: 0.75rem; } 
      .kpi-card { padding: 1rem; }
      .kpi-value { font-size: 1.5rem; }
      .license-section { grid-template-columns: 1fr; gap: 1.5rem; }
      .compliance-bars { gap: 0.75rem; }
      .compliance-bar-item { padding: 0.875rem 1rem; }
      .license-card { padding: 1rem; }
      .license-card-value { font-size: 1.2rem; }
      .license-card-editions { flex-direction: column; gap: 0.5rem; }
      .bu-grid { grid-template-columns: 1fr; } 
      .info-grid { grid-template-columns: 1fr; } 
      .info-item.full-width { grid-column: span 1; }
      .tabs-container { width: 100%; justify-content: center; }
      .tab { padding: 0.5rem 0.8rem; font-size: 0.8rem; }
      .filter-bar { flex-direction: column; }
      .search-input { min-width: 100%; }
      .eos-breakdown { flex-direction: column; gap: 0.5rem; }
    }
    
    @media (max-width: 480px) {
      .kpi-grid { grid-template-columns: 1fr; }
      .kpi-card { padding: 0.875rem; }
      .header h1 { font-size: 1.1rem; }
      .bu-card { padding: 1rem; }
      .bu-name { font-size: 1rem; }
    }
  </style>
</head>
<body>
  <div id="root"></div>
  <script type="text/babel">
    const CONFIG = { GOOGLE_SHEETS: { ENABLED: true, API_KEY: 'AIzaSyD7F4sjl8DUYvfLBOq5N5cXm-AThaDnGdY', SPREADSHEET_ID: '1RldtkHxCkFH9iDVNxEuAW_C1bWSzOlNOv_e5aPjvBFc', SHEET_NAME: 'Data' }, AUTO_REFRESH_MINUTES: 5 };
    const WORKFLOW_STEPS = ["Questionnaire sent", "Questionnaire received", "Initial analysis", "Follow-up sent", "Additional data received", "RVTools received", "SQL scripts received", "Final analysis", "Report delivered"];
    
    // License Entitlements by Subsidiary (from OC_Licences.xlsx - updated)
    const LICENSE_ENTITLEMENTS = {
      "Budenheim": {
        ws_standard: 364,
        ws_datacenter: 30,
        sql_standard: 16,
        sql_enterprise: 32,
        rds_cals: 100,
        hasData: true
      },
      "Martin Braun": {
        ws_standard: 184,
        ws_datacenter: 172,
        sql_standard: 9,
        sql_enterprise: 0,
        rds_cals: 35,
        hasData: true
      },
      "Henkell Freixenet": {
        ws_standard: 968,
        ws_datacenter: 90,
        sql_standard: 14,
        sql_enterprise: 0,
        rds_cals: 62,
        hasData: true // Partial data - pending full analysis
      },
      "OE. Hotels": {
        ws_standard: 160,
        ws_datacenter: 0,
        sql_standard: 49,
        sql_enterprise: 0,
        rds_cals: 3,
        hasData: true // Confirmed: No MS Server deployed, but has license entitlements
      }
    };
    
    // License Requirements (deployed) by Subsidiary
    const LICENSE_REQUIREMENTS = {
      "Budenheim": {
        ws_standard: 248,
        ws_datacenter: 128,
        sql_standard: 16,
        sql_enterprise: 16,
        rds_cals: 70,
        ws_deployed: 138,
        sql_deployed: 4,
        rds_deployed: 4
      },
      "Martin Braun": {
        ws_standard: 96,
        ws_datacenter: 292,
        sql_standard: 32,
        sql_enterprise: 34,
        rds_cals: 1099,
        ws_deployed: 196,
        sql_deployed: 27,
        rds_deployed: 9
      },
      "Henkell Freixenet": {
        ws_standard: 0,
        ws_datacenter: 144,
        sql_standard: 0,
        sql_enterprise: 0,
        rds_cals: 0,
        ws_deployed: 128,
        sql_deployed: 5,
        rds_deployed: 0
      },
      "OE. Hotels": {
        ws_standard: 0,
        ws_datacenter: 0,
        sql_standard: 0,
        sql_enterprise: 0,
        rds_cals: 0,
        ws_deployed: 0,
        sql_deployed: 0,
        rds_deployed: 0
      }
    };

    const DEFAULT_DATA = [
      { unit_id: "1", unit_name: "Agrano KG", subsidiary: "Martin Braun", country: "Germany", questionnaire_status: "Complete", response_rate: 90, priority: "Medium", critical_points: "", missing_data: "", infrastructure_summary: "4 ESXi hosts, 8 VMs, vMotion enabled", ws_deployed: 8, ws_licenses_required: "72 cores Std", sql_deployed: "Express", sql_licenses_required: "Free", rds_deployed: "", rds_licenses_required: "", steps: [true,true,true,true,true,true,false,true,false] },
      { unit_id: "2", unit_name: "Diversi Foods", subsidiary: "Martin Braun", country: "Belgium", questionnaire_status: "Complete", response_rate: 90, priority: "Medium", critical_points: "", missing_data: "", infrastructure_summary: "2 ESXi, vMotion enabled", ws_deployed: 6, ws_licenses_required: "32 cores DC", sql_deployed: "Express", sql_licenses_required: "Free", rds_deployed: "", rds_licenses_required: "", steps: [true,true,true,true,true,true,false,true,false] },
      { unit_id: "3", unit_name: "MBI-Zerouno", subsidiary: "Martin Braun", country: "Italy", questionnaire_status: "Complete", response_rate: 95, priority: "Medium", critical_points: "1x WS 2012 R2 EOS", missing_data: "", infrastructure_summary: "2 ESXi hosts, 10 VMs", ws_deployed: 10, ws_licenses_required: "32 cores Std", sql_deployed: "Express", sql_licenses_required: "Free", rds_deployed: "", rds_licenses_required: "", steps: [true,true,true,true,true,true,true,true,false] },
      { unit_id: "4", unit_name: "MBES", subsidiary: "Martin Braun", country: "Spain", questionnaire_status: "Pending", response_rate: 85, priority: "High", critical_points: "OEM + vMotion conflict", missing_data: "License type clarification", infrastructure_summary: "2 Hyper-V hosts, vMotion", ws_deployed: 5, ws_licenses_required: "24 cores Std", sql_deployed: "4x Express", sql_licenses_required: "Free", rds_deployed: 1, rds_licenses_required: "15 CALs", steps: [true,true,true,true,true,false,false,false,false] },
      { unit_id: "5", unit_name: "WBB", subsidiary: "Martin Braun", country: "Germany", questionnaire_status: "Pending", response_rate: 75, priority: "Critical", critical_points: "SQL Enterprise + vMotion/DRS = Datacenter required", missing_data: "RVTools; Host cores; SQL details", infrastructure_summary: "3 ESXi + Proxmox, 88 VMs, DRS enabled", ws_deployed: 61, ws_licenses_required: "TBD (Datacenter)", sql_deployed: "2 Ent + 3 VMs", sql_licenses_required: "Enterprise TBD", rds_deployed: 1, rds_licenses_required: "195 CALs", steps: [true,true,true,true,false,false,false,false,false] },
      { unit_id: "6", unit_name: "Budenheim", subsidiary: "Budenheim", country: "Germany", questionnaire_status: "Complete", response_rate: 95, priority: "High", critical_points: "SQL Enterprise Always On; DRS on Germany cluster", missing_data: "License proofs", infrastructure_summary: "17 ESXi (376 cores), 138 VMs, 7 countries, DRS on DEBUDVMCL1", ws_deployed: 138, ws_licenses_required: "128c DC + 248c Std", sql_deployed: "2 Ent + 2 Std", sql_licenses_required: "16c Ent + 16c Std", rds_deployed: 4, rds_licenses_required: "70 CALs", steps: [true,true,true,true,true,true,true,true,false] },
      { unit_id: "7", unit_name: "Agrano AG", subsidiary: "Martin Braun", country: "Switzerland", questionnaire_status: "Complete", response_rate: 85, priority: "Medium", critical_points: "", missing_data: "", infrastructure_summary: "2 ESXi hosts", ws_deployed: 6, ws_licenses_required: "32 cores Std", sql_deployed: 1, sql_licenses_required: "8 cores Std", rds_deployed: "", rds_licenses_required: "", steps: [true,true,true,true,true,true,false,true,false] },
      { unit_id: "8", unit_name: "Polen Food", subsidiary: "Martin Braun", country: "Turkey", questionnaire_status: "Complete", response_rate: 90, priority: "High", critical_points: "4x EOS VMs (WS2008R2, WS2012); SQL CALs gap", missing_data: "SQL CAL count", infrastructure_summary: "4 ESXi (68 cores), 18 VMs, 3 sites, HA enabled", ws_deployed: 17, ws_licenses_required: "64 cores Std", sql_deployed: "1 Std + 2 Exp", sql_licenses_required: "4c Std + 60-70 CALs", rds_deployed: 2, rds_licenses_required: "54 CALs", steps: [true,true,true,true,true,true,true,true,false] },
      { unit_id: "9", unit_name: "Montana GB", subsidiary: "Martin Braun", country: "United Kingdom", questionnaire_status: "Complete", response_rate: 95, priority: "Critical", critical_points: "âš ï¸ SQL 2019 ENTERPRISE undeclared (10 cores)", missing_data: "SQL Enterprise license verification", infrastructure_summary: "4 ESXi hosts, 13 VMs, 2 sites", ws_deployed: 11, ws_licenses_required: "64 cores Std", sql_deployed: "1 Std + 1 Ent", sql_licenses_required: "8c Std + 10c Ent âš ï¸", rds_deployed: 1, rds_licenses_required: "500 CALs", steps: [true,true,true,true,true,true,true,true,false] },
      { unit_id: "10", unit_name: "MBPL", subsidiary: "Martin Braun", country: "Poland", questionnaire_status: "Complete", response_rate: 95, priority: "Low", critical_points: "", missing_data: "SQL license proof", infrastructure_summary: "2 Hyper-V hosts (20 cores), 6 VMs, no HA", ws_deployed: 5, ws_licenses_required: "32 cores Std", sql_deployed: "1 Std", sql_licenses_required: "4 cores Std", rds_deployed: "", rds_licenses_required: "", steps: [true,true,true,true,true,true,true,true,false] },
      { unit_id: "11", unit_name: "MBN", subsidiary: "Martin Braun", country: "Netherlands", questionnaire_status: "Pending", response_rate: 70, priority: "Medium", critical_points: "", missing_data: "Windows/SQL editions", infrastructure_summary: "1 physical + VMs", ws_deployed: 4, ws_licenses_required: "8 cores Std", sql_deployed: "TBD", sql_licenses_required: "TBD", rds_deployed: "", rds_licenses_required: "", steps: [true,true,true,true,false,false,false,false,false] },
      { unit_id: "12", unit_name: "MBR", subsidiary: "Martin Braun", country: "-", questionnaire_status: "Out of Scope", response_rate: 0, priority: "", critical_points: "", missing_data: "", infrastructure_summary: "", ws_deployed: "", ws_licenses_required: "", sql_deployed: "", sql_licenses_required: "", rds_deployed: "", rds_licenses_required: "", steps: [false,false,false,false,false,false,false,false,false] },
      { unit_id: "13", unit_name: "MBHU", subsidiary: "Martin Braun", country: "Hungary", questionnaire_status: "Pending", response_rate: 40, priority: "High", critical_points: "", missing_data: "Infrastructure details needed", infrastructure_summary: "TBD", ws_deployed: "", ws_licenses_required: "TBD", sql_deployed: "", sql_licenses_required: "TBD", rds_deployed: "", rds_licenses_required: "", steps: [true,true,false,true,false,false,false,false,false] },
      { unit_id: "14", unit_name: "BE (Dakri)", subsidiary: "Martin Braun", country: "Poland", questionnaire_status: "Complete", response_rate: 90, priority: "Medium", critical_points: "", missing_data: "", infrastructure_summary: "4 ESXi hosts, DRS enabled", ws_deployed: 12, ws_licenses_required: "64 cores DC", sql_deployed: 1, sql_licenses_required: "8 cores Std", rds_deployed: 1, rds_licenses_required: "10 CALs", steps: [true,true,true,true,true,true,true,true,false] },
      { unit_id: "15", unit_name: "Hoffs America", subsidiary: "Martin Braun", country: "USA", questionnaire_status: "Complete", response_rate: 90, priority: "Medium", critical_points: "", missing_data: "", infrastructure_summary: "1 physical server", ws_deployed: 3, ws_licenses_required: "16 cores Std", sql_deployed: "Express", sql_licenses_required: "Free", rds_deployed: 1, rds_licenses_required: "25 CALs", steps: [true,true,true,true,true,true,false,true,false] },
      { unit_id: "16", unit_name: "CAP Fruit", subsidiary: "Martin Braun", country: "France", questionnaire_status: "Complete", response_rate: 85, priority: "Medium", critical_points: "", missing_data: "", infrastructure_summary: "2 ESXi hosts", ws_deployed: 8, ws_licenses_required: "32 cores Std", sql_deployed: "Express", sql_licenses_required: "Free", rds_deployed: "", rds_licenses_required: "", steps: [true,true,true,true,true,true,false,true,false] },
      { unit_id: "17", unit_name: "AU & DE", subsidiary: "Martin Braun", country: "Germany", questionnaire_status: "Complete", response_rate: 90, priority: "High", critical_points: "DRS enabled = Datacenter required; 9x WS 2012 EOS", missing_data: "", infrastructure_summary: "10 ESXi hosts (160 cores), 2 clusters with DRS", ws_deployed: 45, ws_licenses_required: "160 cores DC", sql_deployed: "Enterprise", sql_licenses_required: "Enterprise", rds_deployed: 3, rds_licenses_required: "300 CALs", steps: [true,true,true,true,true,true,true,true,false] },
      { unit_id: "18", unit_name: "Henkell Freixenet Group", subsidiary: "Henkell Freixenet", country: "Germany (HQ)", questionnaire_status: "Pending", response_rate: 85, priority: "Critical", critical_points: "âš ï¸ 56 EOS VMs (WS2003/2008/2012); vMotion active = Datacenter required; GAP -54 cores DC", missing_data: "SQL editions; RDS user count", infrastructure_summary: "6 ESXi (DE:96c + ES:48c = 144 cores), 128 WS VMs (106 on), vMotion active, 2 clusters", ws_deployed: 128, ws_licenses_required: "144 cores DC", sql_deployed: 5, sql_licenses_required: "TBD", rds_deployed: "Yes", rds_licenses_required: "TBD", steps: [true,true,true,true,true,true,false,false,false] },
      { unit_id: "19", unit_name: "OE. Hotels Group", subsidiary: "OE. Hotels", country: "Global", questionnaire_status: "Complete", response_rate: 100, priority: "Low", critical_points: "", missing_data: "", infrastructure_summary: "No Microsoft Server Software used", ws_deployed: 0, ws_licenses_required: "N/A", sql_deployed: 0, sql_licenses_required: "N/A", rds_deployed: 0, rds_licenses_required: "N/A", steps: [true,true,true,true,true,true,true,true,true] },
    ];

    // Compliance Bar Component with License Recommendation
    function ComplianceBar({ label, metric, required, entitled, icon, sku }) {
      const percentage = entitled > 0 ? Math.round((required / entitled) * 100) : (required > 0 ? 999 : 0);
      const isCompliant = percentage <= 100;
      const isWarning = percentage > 80 && percentage <= 100;
      const isOver = percentage > 100;
      const gap = entitled - required;
      const fillWidth = Math.min(isOver ? 100 : percentage, 100);
      const deficit = gap < 0 ? Math.abs(gap) : 0;
      
      // Calculate packs needed (2-core packs for cores, 1:1 for CALs)
      const isCAL = metric.toLowerCase().includes('cal');
      const packsNeeded = isCAL ? deficit : Math.ceil(deficit / 2);
      
      let statusClass = 'compliant';
      if (isOver) statusClass = 'over';
      else if (isWarning) statusClass = 'warning';
      
      return (
        <div className="compliance-row">
          <div className="compliance-bar-item">
            <div className="compliance-bar-header">
              <div className="compliance-bar-label">
                <span>{icon}</span>
                <span>{label}</span>
                <span className="compliance-bar-metric">{metric}</span>
              </div>
              <div className="compliance-bar-values">
                <span className="required">{required.toLocaleString()}</span>
                <span className="entitled"> / {entitled.toLocaleString()}</span>
              </div>
            </div>
            <div className="compliance-bar-container">
              <div 
                className={`compliance-bar-fill ${statusClass}`}
                style={{ width: `${fillWidth}%` }}
              />
              {entitled > 0 && <div className="compliance-bar-marker" style={{ left: `${Math.min(100, (entitled / Math.max(required, entitled)) * 100)}%` }}></div>}
            </div>
            <div className="compliance-bar-footer">
              <span className={`compliance-percentage ${statusClass}`}>
                {percentage > 999 ? 'âˆž' : `${percentage}%`} {isCompliant ? 'âœ“' : 'âš '}
              </span>
              <span className={`compliance-gap ${gap >= 0 ? 'surplus' : 'deficit'}`}>
                {gap >= 0 ? `+${gap.toLocaleString()}` : `${gap.toLocaleString()}`} {isCAL ? 'CALs' : 'cores'}
              </span>
            </div>
          </div>
          
          {/* License Recommendation Card */}
          {deficit > 0 && sku && (
            <div className="license-rec-card">
              <div className="license-rec-header">
                <span className="license-rec-icon">ðŸ“¦</span>
                <span className="license-rec-title">Required</span>
              </div>
              <div className="license-rec-value">{packsNeeded.toLocaleString()}</div>
              <div className="license-rec-sku">{sku}</div>
            </div>
          )}
          
          {/* Compliant badge - only if actually compliant (required > 0) */}
          {deficit === 0 && required > 0 && (
            <div className="license-rec-card compliant">
              <div className="license-rec-check">âœ“</div>
              <div className="license-rec-status">Compliant</div>
              <div className="license-rec-renew">Renew: {isCAL ? required.toLocaleString() : Math.ceil(required/2).toLocaleString()}</div>
              {gap > 0 && <div className="license-rec-saving">(-{isCAL ? gap.toLocaleString() : Math.ceil(gap/2).toLocaleString()})</div>}
            </div>
          )}
          
          {/* Pending badge - when required is 0 but entitled > 0 (surplus/unused licenses) */}
          {deficit === 0 && required === 0 && entitled > 0 && (
            <div className="license-rec-card surplus">
              <div className="license-rec-check">ðŸ’°</div>
              <div className="license-rec-status">Surplus</div>
              <div className="license-rec-surplus">+{entitled.toLocaleString()}</div>
            </div>
          )}
          
          {/* N/A badge - when both required and entitled are 0 */}
          {required === 0 && entitled === 0 && (
            <div className="license-rec-card na">
              <div className="license-rec-check">â€”</div>
              <div className="license-rec-status">N/A</div>
            </div>
          )}
        </div>
      );
    }

    async function fetchGoogleSheetsData() {
      try {
        const { API_KEY, SPREADSHEET_ID, SHEET_NAME } = CONFIG.GOOGLE_SHEETS;
        const url = `https://sheets.googleapis.com/v4/spreadsheets/${SPREADSHEET_ID}/values/${SHEET_NAME}?key=${API_KEY}`;
        const response = await fetch(url);
        if (!response.ok) {
          console.warn('Google Sheets Data fetch failed:', response.status);
          return [];
        }
        const data = await response.json();
        const rows = data.values;
        if (!rows || rows.length < 2) return [];
        const headers = rows[0];
        return rows.slice(1).map(row => {
          const obj = {};
          headers.forEach((h, i) => {
            const key = h.toLowerCase().replace(/\s+/g, '_');
            let val = row[i] || '';
            if (['response_rate','ws_deployed','sql_deployed','rds_deployed'].includes(key)) val = val === '' ? '' : parseInt(val) || 0;
            if (key === 'steps') val = val.split(',').map(v => v.trim().toLowerCase() === 'true');
            obj[key] = val;
          });
          if (!obj.steps || !Array.isArray(obj.steps)) obj.steps = Array(9).fill(false);
          if (!obj.subsidiary) obj.subsidiary = 'Martin Braun';
          return obj;
        });
      } catch (e) {
        console.error('Google Sheets Data error:', e);
        return [];
      }
    }

    // Generate PDF Report
    function generatePDF(data, entitled, required, kpis) {
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      const pageWidth = doc.internal.pageSize.getWidth();
      const margin = 20;
      let y = 20;
      
      // Helper functions
      const addTitle = (text, size = 16) => {
        doc.setFontSize(size);
        doc.setFont('helvetica', 'bold');
        doc.setTextColor(26, 26, 46);
        doc.text(text, margin, y);
        y += size * 0.5 + 5;
      };
      
      const addText = (text, size = 10) => {
        doc.setFontSize(size);
        doc.setFont('helvetica', 'normal');
        doc.setTextColor(60, 60, 60);
        const lines = doc.splitTextToSize(text, pageWidth - 2 * margin);
        doc.text(lines, margin, y);
        y += lines.length * size * 0.4 + 3;
      };
      
      const addLine = () => {
        doc.setDrawColor(200, 200, 200);
        doc.line(margin, y, pageWidth - margin, y);
        y += 5;
      };
      
      const checkNewPage = (needed = 30) => {
        if (y > 270 - needed) {
          doc.addPage();
          y = 20;
        }
      };
      
      // Page 1: Title
      doc.setFillColor(26, 26, 46);
      doc.rect(0, 0, pageWidth, 60, 'F');
      doc.setFontSize(24);
      doc.setFont('helvetica', 'bold');
      doc.setTextColor(255, 255, 255);
      doc.text('Microsoft Server Licensing', margin, 30);
      doc.setFontSize(16);
      doc.text('Assessment Report - Oetker Collection', margin, 42);
      doc.setFontSize(10);
      doc.setFont('helvetica', 'normal');
      doc.text('Generated: ' + new Date().toLocaleDateString(), margin, 55);
      
      y = 75;
      
      // Executive Summary
      addTitle('Executive Summary', 14);
      addLine();
      addText(`Total Business Units Analyzed: ${kpis.total}`);
      addText(`Completed Assessments: ${kpis.complete} (${kpis.total > 0 ? Math.round(kpis.complete/kpis.total*100) : 0}%)`);
      addText(`Average Response Rate: ${kpis.avg}%`);
      addText(`Critical/High Priority Items: ${kpis.critical}`);
      addText(`Pending Actions: ${kpis.pending}`);
      y += 10;
      
      // License Compliance Status - Visual Cards
      addTitle('License Compliance Status', 14);
      addLine();
      
      const products = [
        { name: 'Windows Server Datacenter', req: required.ws_datacenter || 0, ent: entitled.ws_datacenter || 0, unit: 'cores', icon: 'ðŸ–¥ï¸' },
        { name: 'Windows Server Standard', req: required.ws_standard || 0, ent: entitled.ws_standard || 0, unit: 'cores', icon: 'ðŸ–¥ï¸' },
        { name: 'SQL Server Enterprise', req: required.sql_enterprise || 0, ent: entitled.sql_enterprise || 0, unit: 'cores', icon: 'ðŸ—„ï¸' },
        { name: 'SQL Server Standard', req: required.sql_standard || 0, ent: entitled.sql_standard || 0, unit: 'cores', icon: 'ðŸ—„ï¸' },
        { name: 'RDS User CALs', req: required.rds_cals || 0, ent: entitled.rds_cals || 0, unit: 'CALs', icon: 'ðŸ‘¥' }
      ];
      
      const cardHeight = 22;
      const barWidth = 90;
      const cardWidth = pageWidth - 2 * margin;
      
      products.forEach(p => {
        checkNewPage(cardHeight + 5);
        const gap = p.ent - p.req;
        const pct = p.ent > 0 ? Math.round((p.req / p.ent) * 100) : (p.req > 0 ? 999 : 0);
        const isCompliant = gap >= 0;
        const fillPct = Math.min(pct, 100) / 100;
        
        // Card background
        doc.setFillColor(245, 247, 250);
        doc.roundedRect(margin, y, cardWidth, cardHeight, 3, 3, 'F');
        
        // Product name
        doc.setFont('helvetica', 'bold');
        doc.setFontSize(10);
        doc.setTextColor(26, 26, 46);
        doc.text(p.name, margin + 5, y + 8);
        
        // Values (Required / Entitled)
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(9);
        doc.setTextColor(100, 100, 100);
        doc.text(`${p.req.toLocaleString()} / ${p.ent.toLocaleString()} ${p.unit}`, margin + 5, y + 16);
        
        // Progress bar background
        const barX = margin + 95;
        const barY = y + 7;
        const barHeight = 10;
        doc.setFillColor(220, 220, 225);
        doc.roundedRect(barX, barY, barWidth, barHeight, 2, 2, 'F');
        
        // Progress bar fill
        if (fillPct > 0) {
          if (isCompliant) {
            doc.setFillColor(16, 185, 129); // Green
          } else {
            doc.setFillColor(239, 68, 68); // Red
          }
          doc.roundedRect(barX, barY, barWidth * fillPct, barHeight, 2, 2, 'F');
        }
        
        // Percentage badge
        const badgeX = barX + barWidth + 5;
        if (isCompliant) {
          doc.setFillColor(220, 252, 231); // Light green
          doc.setTextColor(22, 163, 74); // Green text
        } else {
          doc.setFillColor(254, 226, 226); // Light red
          doc.setTextColor(220, 38, 38); // Red text
        }
        doc.roundedRect(badgeX, barY, 25, barHeight, 2, 2, 'F');
        doc.setFontSize(8);
        doc.setFont('helvetica', 'bold');
        doc.text(`${pct > 999 ? 'âˆž' : pct}%`, badgeX + 5, barY + 7);
        
        // Gap/Surplus indicator
        const gapX = badgeX + 30;
        doc.setFontSize(9);
        if (isCompliant) {
          doc.setTextColor(22, 163, 74);
          doc.text(`+${gap.toLocaleString()}`, gapX, y + 14);
        } else {
          doc.setTextColor(220, 38, 38);
          doc.text(`${gap.toLocaleString()}`, gapX, y + 14);
        }
        
        y += cardHeight + 4;
      });
      y += 6;
      
      // Purchase Recommendations - Visual Cards
      checkNewPage(80);
      addTitle('Purchase Recommendations', 14);
      addLine();
      
      let hasPurchase = false;
      const purchaseItems = [];
      products.forEach(p => {
        const gap = p.ent - p.req;
        if (gap < 0) {
          hasPurchase = true;
          const deficit = Math.abs(gap);
          const packs = p.unit === 'CALs' ? deficit : Math.ceil(deficit / 2);
          const sku = p.unit === 'CALs' ? 'RDS User CAL LIC+SA' : p.name.replace('Windows Server ', 'WS ').replace('SQL Server ', 'SQL ') + ' 2-Core LIC+SA';
          purchaseItems.push({ packs, sku, deficit, unit: p.unit });
        }
      });
      
      if (hasPurchase) {
        const recCardWidth = (pageWidth - 2 * margin - 10) / 2;
        const recCardHeight = 35;
        let recX = margin;
        let recRow = 0;
        
        purchaseItems.forEach((item, idx) => {
          if (idx > 0 && idx % 2 === 0) {
            y += recCardHeight + 5;
            recX = margin;
          }
          
          checkNewPage(recCardHeight + 10);
          
          // Card with gradient effect (red tint)
          doc.setFillColor(254, 242, 242);
          doc.roundedRect(recX, y, recCardWidth, recCardHeight, 4, 4, 'F');
          doc.setDrawColor(252, 165, 165);
          doc.roundedRect(recX, y, recCardWidth, recCardHeight, 4, 4, 'S');
          
          // Quantity
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(18);
          doc.setTextColor(220, 38, 38);
          doc.text(item.packs.toLocaleString(), recX + 8, y + 15);
          
          // SKU name
          doc.setFont('helvetica', 'normal');
          doc.setFontSize(8);
          doc.setTextColor(100, 100, 100);
          const skuLines = doc.splitTextToSize(item.sku, recCardWidth - 16);
          doc.text(skuLines, recX + 8, y + 23);
          
          // Gap info
          doc.setFontSize(7);
          doc.setTextColor(150, 150, 150);
          doc.text(`(${item.deficit.toLocaleString()} ${item.unit} gap)`, recX + 8, y + 31);
          
          recX += recCardWidth + 10;
        });
        
        y += recCardHeight + 10;
      } else {
        doc.setFillColor(240, 253, 244);
        doc.roundedRect(margin, y, cardWidth, 20, 4, 4, 'F');
        doc.setFont('helvetica', 'normal');
        doc.setFontSize(10);
        doc.setTextColor(22, 163, 74);
        doc.text('âœ“ No immediate purchases required. Review renewal quantities below.', margin + 10, y + 13);
        y += 28;
      }
      
      // Renewal Recommendations - Visual Cards
      checkNewPage(80);
      addTitle('Renewal Recommendations', 14);
      addLine();
      
      doc.setFont('helvetica', 'normal');
      doc.setFontSize(10);
      doc.setTextColor(100, 100, 100);
      doc.text('At next renewal, consider optimizing license quantities:', margin, y);
      y += 10;
      
      const renewItems = [];
      products.forEach(p => {
        const gap = p.ent - p.req;
        if (gap > 0 && p.req > 0) {
          const renewPacks = p.unit === 'CALs' ? p.req : Math.ceil(p.req / 2);
          const savePacks = p.unit === 'CALs' ? gap : Math.ceil(gap / 2);
          renewItems.push({ name: p.name, renew: renewPacks, save: savePacks });
        }
      });
      
      if (renewItems.length > 0) {
        renewItems.forEach(item => {
          checkNewPage(25);
          
          // Green card for savings
          doc.setFillColor(240, 253, 244);
          doc.roundedRect(margin, y, cardWidth, 18, 3, 3, 'F');
          doc.setDrawColor(134, 239, 172);
          doc.roundedRect(margin, y, cardWidth, 18, 3, 3, 'S');
          
          // Product name
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(9);
          doc.setTextColor(26, 26, 46);
          doc.text(item.name, margin + 5, y + 11);
          
          // Renew value
          doc.setFont('helvetica', 'normal');
          doc.setTextColor(100, 100, 100);
          doc.text(`Renew: ${item.renew.toLocaleString()}`, margin + 90, y + 11);
          
          // Savings badge
          doc.setFillColor(22, 163, 74);
          doc.roundedRect(margin + 140, y + 4, 30, 10, 2, 2, 'F');
          doc.setFont('helvetica', 'bold');
          doc.setFontSize(8);
          doc.setTextColor(255, 255, 255);
          doc.text(`-${item.save.toLocaleString()}`, margin + 145, y + 11);
          
          y += 22;
        });
      } else {
        doc.setFontSize(9);
        doc.setTextColor(100, 100, 100);
        doc.text('No renewal optimization opportunities identified.', margin, y);
        y += 10;
      }
      y += 5;
      
      // Remediation Plan
      checkNewPage(80);
      addTitle('Remediation Plan', 14);
      addLine();
      
      doc.setFont('helvetica', 'bold');
      addText('1. Licensing Gap Resolution (Priority: HIGH)');
      doc.setFont('helvetica', 'normal');
      addText('   - Procure missing licenses identified above');
      addText('   - Timeline: Immediate (within 30 days)');
      y += 3;
      
      doc.setFont('helvetica', 'bold');
      addText('2. End of Support Migration (Priority: MEDIUM)');
      doc.setFont('helvetica', 'normal');
      addText('   - 14 VMs running unsupported Windows versions');
      addText('   - WS 2008 R2: 2 VMs, WS 2012: 3 VMs, WS 2012 R2: 9 VMs');
      addText('   - Affected: MBI-Zerouno, Polen Food, AU & DE');
      addText('   - Timeline: 90 days');
      y += 3;
      
      doc.setFont('helvetica', 'bold');
      addText('3. Architecture Optimization (Priority: LOW)');
      doc.setFont('helvetica', 'normal');
      addText('   - Review DRS/vMotion configurations');
      addText('   - Evaluate Standard vs Datacenter requirements');
      addText('   - Timeline: Next renewal cycle');
      y += 10;
      
      // BU Status Summary
      doc.addPage();
      y = 20;
      addTitle('Business Unit Status Summary', 14);
      addLine();
      
      // Table header
      doc.setFillColor(240, 240, 240);
      doc.rect(margin, y, pageWidth - 2 * margin, 8, 'F');
      doc.setFont('helvetica', 'bold');
      doc.setFontSize(8);
      doc.text('Unit', margin + 2, y + 5);
      doc.text('Subsidiary', margin + 45, y + 5);
      doc.text('Status', margin + 85, y + 5);
      doc.text('Priority', margin + 115, y + 5);
      doc.text('Response', margin + 140, y + 5);
      y += 10;
      
      // Table rows
      doc.setFont('helvetica', 'normal');
      data.filter(bu => bu.questionnaire_status !== 'Out of Scope').forEach(bu => {
        checkNewPage(8);
        doc.text(bu.unit_name.substring(0, 20), margin + 2, y + 4);
        doc.text((bu.subsidiary || '').substring(0, 18), margin + 45, y + 4);
        doc.text(bu.questionnaire_status || '', margin + 85, y + 4);
        doc.text(bu.priority || '-', margin + 115, y + 4);
        doc.text((bu.response_rate || 0) + '%', margin + 140, y + 4);
        y += 7;
      });
      
      // Footer on each page
      const totalPages = doc.internal.getNumberOfPages();
      for (let i = 1; i <= totalPages; i++) {
        doc.setPage(i);
        doc.setFontSize(8);
        doc.setTextColor(150, 150, 150);
        doc.text('Confidential - Oetker Collection Microsoft Licensing Assessment', margin, 290);
        doc.text(`Page ${i} of ${totalPages}`, pageWidth - margin - 20, 290);
      }
      
      // Save
      doc.save('Oetker_MS_Licensing_Report_' + new Date().toISOString().split('T')[0] + '.pdf');
    }

    function App() {
      const [data, setData] = React.useState(DEFAULT_DATA);
      const [loading, setLoading] = React.useState(false);
      const [lastUpdate, setLastUpdate] = React.useState(new Date());
      const [activeTab, setActiveTab] = React.useState("all");
      const [searchTerm, setSearchTerm] = React.useState("");
      const [selectedBU, setSelectedBU] = React.useState(null);
      const [subsidiaryFilter, setSubsidiaryFilter] = React.useState("all");
      const [showEOS, setShowEOS] = React.useState(false);
      const [showEntitlements, setShowEntitlements] = React.useState(false);

      React.useEffect(() => {
        if (!CONFIG.GOOGLE_SHEETS.ENABLED) return;
        const load = async () => {
          setLoading(true);
          try { 
            const d = await fetchGoogleSheetsData(); 
            if (d && d.length) setData(d); 
          } catch(e) { console.error('Data fetch failed:', e); }
          setLastUpdate(new Date());
          setLoading(false);
        };
        load();
        if (CONFIG.AUTO_REFRESH_MINUTES > 0) { const i = setInterval(load, CONFIG.AUTO_REFRESH_MINUTES * 60000); return () => clearInterval(i); }
      }, []);

      // Get subsidiaries with data status
      const subsidiaries = ["Martin Braun", "Budenheim", "Henkell Freixenet", "OE. Hotels"];
      
      const subsidiaryFiltered = subsidiaryFilter === "all" 
        ? data 
        : data.filter(bu => bu.subsidiary === subsidiaryFilter);

      const filtered = subsidiaryFiltered.filter(bu => {
        const match = bu.unit_name.toLowerCase().includes(searchTerm.toLowerCase()) || 
                      bu.country.toLowerCase().includes(searchTerm.toLowerCase()) || 
                      bu.unit_id.toLowerCase().includes(searchTerm.toLowerCase());
        if (activeTab === "all") return match;
        if (activeTab === "high") return match && (bu.priority === "High" || bu.priority === "Critical");
        if (activeTab === "pending") return match && (bu.questionnaire_status === "Pending" || bu.response_rate < 70);
        if (activeTab === "complete") return match && bu.questionnaire_status === "Complete";
        return match;
      });

      // Calculate aggregated license data based on filter
      const getAggregatedLicenses = () => {
        if (subsidiaryFilter === "all") {
          // Sum only subsidiaries with deployment data (hasData: true)
          const analyzedSubs = Object.entries(LICENSE_ENTITLEMENTS).filter(([_, s]) => s.hasData);
          const entitled = {
            ws_standard: analyzedSubs.reduce((sum, [_, s]) => sum + s.ws_standard, 0),
            ws_datacenter: analyzedSubs.reduce((sum, [_, s]) => sum + s.ws_datacenter, 0),
            sql_standard: analyzedSubs.reduce((sum, [_, s]) => sum + s.sql_standard, 0),
            sql_enterprise: analyzedSubs.reduce((sum, [_, s]) => sum + s.sql_enterprise, 0),
            rds_cals: analyzedSubs.reduce((sum, [_, s]) => sum + s.rds_cals, 0),
          };
          const required = {
            ws_standard: Object.values(LICENSE_REQUIREMENTS).reduce((sum, s) => sum + s.ws_standard, 0),
            ws_datacenter: Object.values(LICENSE_REQUIREMENTS).reduce((sum, s) => sum + s.ws_datacenter, 0),
            sql_standard: Object.values(LICENSE_REQUIREMENTS).reduce((sum, s) => sum + s.sql_standard, 0),
            sql_enterprise: Object.values(LICENSE_REQUIREMENTS).reduce((sum, s) => sum + s.sql_enterprise, 0),
            rds_cals: Object.values(LICENSE_REQUIREMENTS).reduce((sum, s) => sum + s.rds_cals, 0),
            ws_deployed: Object.values(LICENSE_REQUIREMENTS).reduce((sum, s) => sum + s.ws_deployed, 0),
            sql_deployed: Object.values(LICENSE_REQUIREMENTS).reduce((sum, s) => sum + s.sql_deployed, 0),
            rds_deployed: Object.values(LICENSE_REQUIREMENTS).reduce((sum, s) => sum + s.rds_deployed, 0),
          };
          const hasData = analyzedSubs.length > 0;
          return { entitled, required, hasData };
        } else {
          const entitled = LICENSE_ENTITLEMENTS[subsidiaryFilter] || {};
          const required = LICENSE_REQUIREMENTS[subsidiaryFilter] || {};
          const hasData = entitled.hasData || false;
          return { entitled, required, hasData };
        }
      };

      const { entitled, required, hasData } = getAggregatedLicenses();

      const activeData = subsidiaryFiltered.filter(b => b.questionnaire_status !== "Out of Scope");
      const kpis = { 
        total: activeData.length, 
        complete: activeData.filter(b => b.questionnaire_status === "Complete").length,
        avg: activeData.length > 0 ? Math.round(activeData.reduce((a,b) => a + (b.response_rate||0), 0) / activeData.length) : 0, 
        critical: activeData.filter(b => b.priority === "Critical" || b.priority === "High").length, 
        pending: activeData.filter(b => b.questionnaire_status === "Pending").length
      };

      const statusClass = s => {
        if (s === "Complete") return "complete";
        if (s === "Received") return "received";
        if (s === "Pending") return "pending";
        if (s === "Incomplete") return "incomplete";
        if (s === "Out of Scope") return "out-of-scope";
        if (s === "No Data") return "no-data";
        return "not-sent";
      };

      const subsidiaryClass = s => {
        if (s === "Budenheim") return "budenheim";
        if (s === "Martin Braun") return "martin-braun";
        if (s === "Henkell Freixenet") return "henkell-freixenet";
        if (s === "OE. Hotels") return "oe-hotels";
        return "martin-braun";
      };

      const hasLicense = bu => bu.ws_deployed !== '' || bu.sql_deployed !== '' || bu.rds_deployed !== '';

      return (
        <div className="app-container">
          <div className="header-wrapper">
            <header className="header">
              <div className="logo-section">
                <svg className="logo-img" viewBox="0 0 200 50"><circle cx="12" cy="12" r="5" fill="#E87A2A"/><circle cx="22" cy="8" r="8" fill="#E87A2A"/><circle cx="12" cy="28" r="8" fill="#E87A2A"/><circle cx="22" cy="38" r="5" fill="#E87A2A"/><circle cx="8" cy="40" r="4" fill="#E87A2A"/><text x="38" y="32" fontFamily="DM Sans" fontSize="24" fontWeight="700" fill="white">appstrato</text></svg>
                <div className="logo-text"><h1>Microsoft Licensing Tracker</h1><span>Oetker Collection</span></div>
              </div>
              <div className="header-right">
                <div className="subsidiary-filter">
                  <label>Subsidiary:</label>
                  <select value={subsidiaryFilter} onChange={e => setSubsidiaryFilter(e.target.value)}>
                    <option value="all">All Subsidiaries</option>
                    {subsidiaries.map(s => (
                      <option key={s} value={s}>{s} {!LICENSE_ENTITLEMENTS[s]?.hasData ? '(No data)' : ''}</option>
                    ))}
                  </select>
                </div>
                <div>
                  <div className="last-update">Updated: {lastUpdate.toLocaleString()}</div>
                  {loading && <div className="loading-indicator"><div className="loading-dot"></div> Syncing...</div>}
                </div>
              </div>
            </header>
          </div>

          {/* KPI Grid - 5 cards */}
          <div className="kpi-grid">
            <div className="kpi-card"><div className="kpi-label">Total BUs</div><div className="kpi-value">{kpis.total}</div></div>
            <div className="kpi-card green"><div className="kpi-label">Complete</div><div className="kpi-value">{kpis.complete}</div><div className="kpi-subtitle">{kpis.total > 0 ? Math.round(kpis.complete/kpis.total*100) : 0}%</div></div>
            <div className="kpi-card"><div className="kpi-label">Avg Response</div><div className="kpi-value">{kpis.avg}%</div></div>
            <div className="kpi-card red"><div className="kpi-label">Critical/High</div><div className="kpi-value">{kpis.critical}</div></div>
            <div className="kpi-card yellow"><div className="kpi-label">Pending</div><div className="kpi-value">{kpis.pending}</div></div>
          </div>

          {/* Main License Section */}
          <div className="license-section">
            {/* Compliance Bars */}
            <div className="compliance-panel">
              <div className="section-header">
                <span className="section-title">License Compliance</span>
                <span className="estimated-label">(Estimated)</span>
                {subsidiaryFilter !== "all" && required.ws_datacenter === 0 && required.ws_standard === 0 && entitled.ws_standard > 0 && subsidiaryFilter === "Henkell Freixenet" && (
                  <span className="pending-badge">â³ Deployment data pending</span>
                )}
                {subsidiaryFilter === "OE. Hotels" && (
                  <span className="surplus-badge">ðŸ’° Unused licenses - potential reallocation</span>
                )}
                <div className="section-header-spacer"></div>
                <button className="export-btn" onClick={() => setShowEntitlements(true)}>
                  ðŸ“œ Entitlements
                </button>
                <button className="export-btn disabled" disabled title="Will be activated upon completion">
                  ðŸ“„ Export
                </button>
              </div>
              
              {hasData ? (
                <div className="compliance-bars">
                  <ComplianceBar 
                    label="Windows Server Datacenter" 
                    metric="Cores" 
                    required={required.ws_datacenter || 0} 
                    entitled={entitled.ws_datacenter || 0}
                    icon="ðŸ–¥ï¸"
                    sku="WS Datacenter 2-Core LIC+SA"
                  />
                  <ComplianceBar 
                    label="Windows Server Standard" 
                    metric="Cores" 
                    required={required.ws_standard || 0} 
                    entitled={entitled.ws_standard || 0}
                    icon="ðŸ–¥ï¸"
                    sku="WS Standard 2-Core LIC+SA"
                  />
                  <ComplianceBar 
                    label="SQL Server Enterprise" 
                    metric="Cores" 
                    required={required.sql_enterprise || 0} 
                    entitled={entitled.sql_enterprise || 0}
                    icon="ðŸ—„ï¸"
                    sku="SQL Enterprise 2-Core LIC+SA"
                  />
                  <ComplianceBar 
                    label="SQL Server Standard" 
                    metric="Cores" 
                    required={required.sql_standard || 0} 
                    entitled={entitled.sql_standard || 0}
                    icon="ðŸ—„ï¸"
                    sku="SQL Standard 2-Core LIC+SA"
                  />
                  <ComplianceBar 
                    label="RDS User CALs" 
                    metric="User CALs" 
                    required={required.rds_cals || 0} 
                    entitled={entitled.rds_cals || 0}
                    icon="ðŸ‘¥"
                    sku="RDS User CAL LIC+SA"
                  />
                </div>
              ) : (
                <div className="no-data-state">
                  <div className="no-data-icon">ðŸ“Š</div>
                  <div className="no-data-text">No deployment data available</div>
                  <div className="no-data-subtext">Analysis pending for {subsidiaryFilter}</div>
                </div>
              )}
            </div>
          </div>

          <div style={{fontSize:'0.7rem',color:'rgba(255,255,255,0.4)',marginTop:'-0.5rem',marginBottom:'2rem'}}>* Some BUs have pending data (TBD) - totals may increase</div>

          {/* Data Collection Section */}
          <div className="section-header">
            <span className="section-title">Data Collection & Analysis</span>
          </div>

          <div className="tabs-container">
            {[{id:"all",label:"All"},{id:"high",label:"Critical/High"},{id:"pending",label:"Pending"},{id:"complete",label:"Complete"}].map(t => <button key={t.id} className={`tab ${activeTab===t.id?'active':''}`} onClick={() => setActiveTab(t.id)}>{t.label}</button>)}
          </div>

          <div className="filter-bar">
            <input className="search-input" placeholder="ðŸ” Search by name, country, or ID..." value={searchTerm} onChange={e => setSearchTerm(e.target.value)} />
            <div className="eos-badge" onClick={() => setShowEOS(true)}>
              <span className="eos-badge-icon">âš ï¸</span>
              <span className="eos-badge-text">End of Support</span>
              <span className="eos-badge-count">70</span>
            </div>
          </div>

          <div className="bu-grid">
            {filtered.map(bu => (
              <div key={bu.unit_id} className="bu-card" onClick={() => setSelectedBU(bu)}>
                {bu.priority && bu.priority !== '' && <span className={`priority-badge ${bu.priority.toLowerCase()}`}>{bu.priority}</span>}
                <div className="bu-card-header">
                  <div>
                    <span className="bu-unit-badge">Unit {bu.unit_id}</span>
                    <div className="bu-name">{bu.unit_name}</div>
                    <div className="bu-country">ðŸ“ {bu.country}</div>
                    <div className="bu-subsidiary">
                      <span className={`subsidiary-tag ${subsidiaryClass(bu.subsidiary)}`}>{bu.subsidiary}</span>
                    </div>
                  </div>
                  <span className={`status-badge ${statusClass(bu.questionnaire_status)}`}><span className="status-dot"></span>{bu.questionnaire_status}</span>
                </div>
                {bu.infrastructure_summary && <div className="bu-infra-summary">ðŸ—ï¸ {bu.infrastructure_summary}</div>}
                <div className="progress-section"><div className="progress-header"><span className="progress-label">Response Rate</span><span className="progress-value">{bu.response_rate}%</span></div><div className="progress-bar"><div className="progress-fill" style={{width:`${bu.response_rate}%`}}></div></div></div>
                <div className="license-summary">
                  {bu.ws_deployed !== '' && <span className="license-tag ws">ðŸ–¥ï¸ WS: {bu.ws_deployed}</span>}
                  {bu.sql_deployed !== '' && <span className="license-tag sql">ðŸ—„ï¸ SQL: {bu.sql_deployed}</span>}
                  {bu.rds_deployed !== '' && <span className="license-tag rds">ðŸ‘¥ RDS: {bu.rds_deployed}</span>}
                  {!hasLicense(bu) && <span className="no-data">No license data yet</span>}
                </div>
                <div className="checklist-mini">{(bu.steps||[]).map((d,i) => <div key={i} className={`check-dot ${d?'done':''}`}></div>)}</div>
              </div>
            ))}
          </div>

          {selectedBU && (
            <div className="modal-overlay" onClick={() => setSelectedBU(null)}>
              <div className="modal-content" onClick={e => e.stopPropagation()}>
                <div className="modal-header">
                  <div>
                    <span className="bu-unit-badge">Unit {selectedBU.unit_id}</span>
                    <h2 style={{fontSize:'1.5rem',marginTop:'0.5rem',color:'var(--text-primary)'}}>{selectedBU.unit_name}</h2>
                    <div className="bu-country">ðŸ“ {selectedBU.country}</div>
                    <div style={{marginTop:'0.5rem'}}><span className={`subsidiary-tag ${subsidiaryClass(selectedBU.subsidiary)}`}>{selectedBU.subsidiary}</span></div>
                  </div>
                  <button className="modal-close" onClick={() => setSelectedBU(null)}>Ã—</button>
                </div>
                <div className="modal-body">
                  <div className="detail-section"><h3>Status</h3>
                    <div className="info-grid">
                      <div className="info-item"><div className="info-label">Status</div><div className="info-value">{selectedBU.questionnaire_status}</div></div>
                      <div className="info-item"><div className="info-label">Response</div><div className="info-value">{selectedBU.response_rate}%</div></div>
                      <div className="info-item"><div className="info-label">Priority</div><div className="info-value">{selectedBU.priority || 'â€”'}</div></div>
                      <div className="info-item"><div className="info-label">Country</div><div className="info-value">{selectedBU.country}</div></div>
                      {selectedBU.infrastructure_summary && <div className="info-item full-width"><div className="info-label">Infrastructure Summary</div><div className="info-value infra">ðŸ—ï¸ {selectedBU.infrastructure_summary}</div></div>}
                    </div>
                  </div>
                  <div className="detail-section"><h3>License Requirements</h3><table className="license-table"><thead><tr><th>Product</th><th>Deployed</th><th>Required</th></tr></thead><tbody><tr><td><div className="product-cell"><span className="product-icon ws">WS</span>Windows Server</div></td><td className="value-cell">{selectedBU.ws_deployed!==''?selectedBU.ws_deployed:'â€”'}</td><td className="required-cell">{selectedBU.ws_licenses_required||'â€”'}</td></tr><tr><td><div className="product-cell"><span className="product-icon sql">SQL</span>SQL Server</div></td><td className="value-cell">{selectedBU.sql_deployed!==''?selectedBU.sql_deployed:'â€”'}</td><td className="required-cell">{selectedBU.sql_licenses_required||'â€”'}</td></tr><tr><td><div className="product-cell"><span className="product-icon rds">RDS</span>Remote Desktop</div></td><td className="value-cell">{selectedBU.rds_deployed!==''?selectedBU.rds_deployed:'â€”'}</td><td className="required-cell">{selectedBU.rds_licenses_required||'â€”'}</td></tr></tbody></table></div>
                  {selectedBU.critical_points && <div className="detail-section"><h3>Critical Points</h3><div className="alert-box"><div className="alert-title">âš ï¸ Attention</div><div className="alert-content">{selectedBU.critical_points}</div></div></div>}
                  {selectedBU.missing_data && <div className="detail-section"><h3>Missing Data</h3><div className="alert-box warning"><div className="alert-title">ðŸ“‹ Requested</div><div className="alert-content">{selectedBU.missing_data}</div></div></div>}
                  <div className="detail-section"><h3>Workflow</h3><div className="checklist-full">{WORKFLOW_STEPS.map((s,i) => <div key={i} className="checklist-item"><div className={`checklist-checkbox ${(selectedBU.steps||[])[i]?'checked':''}`}></div><span className={`checklist-text ${(selectedBU.steps||[])[i]?'done':''}`}>{s}</span></div>)}</div></div>
                </div>
              </div>
            </div>
          )}

          {/* EOS Modal */}
          {showEOS && (
            <div className="modal-overlay" onClick={() => setShowEOS(false)}>
              <div className="eos-modal" onClick={e => e.stopPropagation()}>
                <div className="eos-modal-header">
                  <div className="eos-modal-title">
                    <span>âš ï¸</span>
                    <span>End of Support Systems</span>
                  </div>
                  <button className="eos-modal-close" onClick={() => setShowEOS(false)}>Ã—</button>
                </div>
                <div className="eos-modal-value">70</div>
                <div className="eos-modal-label">VMs running unsupported Windows versions</div>
                <div className="eos-modal-breakdown">
                  <div className="eos-modal-item">
                    <div className="eos-modal-item-left">
                      <div className="eos-modal-dot critical"></div>
                      <span className="eos-modal-item-label">Windows Server 2003</span>
                    </div>
                    <span className="eos-modal-item-count">21</span>
                  </div>
                  <div className="eos-modal-item">
                    <div className="eos-modal-item-left">
                      <div className="eos-modal-dot critical"></div>
                      <span className="eos-modal-item-label">Windows Server 2008 R2</span>
                    </div>
                    <span className="eos-modal-item-count">22</span>
                  </div>
                  <div className="eos-modal-item">
                    <div className="eos-modal-item-left">
                      <div className="eos-modal-dot high"></div>
                      <span className="eos-modal-item-label">Windows Server 2012</span>
                    </div>
                    <span className="eos-modal-item-count">18</span>
                  </div>
                  <div className="eos-modal-item">
                    <div className="eos-modal-item-left">
                      <div className="eos-modal-dot medium"></div>
                      <span className="eos-modal-item-label">Windows Server 2012 R2</span>
                    </div>
                    <span className="eos-modal-item-count">9</span>
                  </div>
                </div>
                <div className="eos-modal-affected">
                  <strong>Affected BUs:</strong> MBI-Zerouno, Polen Food, AU & DE, Henkell Freixenet (56 VMs)
                </div>
              </div>
            </div>
          )}

          {showEntitlements && (
            <div className="modal-overlay" onClick={() => setShowEntitlements(false)}>
              <div className="entitlements-modal" onClick={e => e.stopPropagation()} style={{maxWidth: '900px'}}>
                <div className="eos-modal-header">
                  <div className="eos-modal-title">
                    <span>ðŸ“œ</span>
                    <span>License Entitlements by Subsidiary</span>
                  </div>
                  <button className="eos-modal-close" onClick={() => setShowEntitlements(false)}>Ã—</button>
                </div>
                
                <div style={{fontSize: '0.75rem', color: '#E87A2A', fontWeight: '600', marginBottom: '8px', marginTop: '10px'}}>CORE LICENSES (EA + MPSA)</div>
                <div className="entitlements-table-wrapper">
                  <table className="entitlements-table">
                    <thead>
                      <tr>
                        <th>Subsidiary</th>
                        <th>WS DC</th>
                        <th>WS Std</th>
                        <th>SQL Ent</th>
                        <th>SQL Std</th>
                        <th>RDS User</th>
                      </tr>
                    </thead>
                    <tbody>
                      {Object.entries(LICENSE_ENTITLEMENTS).map(([name, ent]) => (
                        <tr key={name}>
                          <td className="sub-name">{name}</td>
                          <td>{ent.ws_datacenter.toLocaleString()}</td>
                          <td>{ent.ws_standard.toLocaleString()}</td>
                          <td>{ent.sql_enterprise.toLocaleString()}</td>
                          <td>{ent.sql_standard.toLocaleString()}</td>
                          <td>{ent.rds_cals.toLocaleString()}</td>
                        </tr>
                      ))}
                    </tbody>
                    <tfoot>
                      <tr>
                        <td className="sub-name">TOTAL</td>
                        <td>{Object.values(LICENSE_ENTITLEMENTS).reduce((s,e) => s + e.ws_datacenter, 0).toLocaleString()}</td>
                        <td>{Object.values(LICENSE_ENTITLEMENTS).reduce((s,e) => s + e.ws_standard, 0).toLocaleString()}</td>
                        <td>{Object.values(LICENSE_ENTITLEMENTS).reduce((s,e) => s + e.sql_enterprise, 0).toLocaleString()}</td>
                        <td>{Object.values(LICENSE_ENTITLEMENTS).reduce((s,e) => s + e.sql_standard, 0).toLocaleString()}</td>
                        <td>{Object.values(LICENSE_ENTITLEMENTS).reduce((s,e) => s + e.rds_cals, 0).toLocaleString()}</td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
                
                <div style={{fontSize: '0.75rem', color: '#E87A2A', fontWeight: '600', marginBottom: '8px', marginTop: '15px'}}>ADDITIONAL LICENSES (MPSA)</div>
                <div className="entitlements-table-wrapper">
                  <table className="entitlements-table">
                    <thead>
                      <tr>
                        <th>Subsidiary</th>
                        <th>RDS Device</th>
                        <th>WS CAL</th>
                        <th>SQL CAL</th>
                        <th>Exchange</th>
                        <th>SharePoint</th>
                      </tr>
                    </thead>
                    <tbody>
                      <tr>
                        <td className="sub-name">Budenheim</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>2 Srv</td>
                      </tr>
                      <tr>
                        <td className="sub-name">Martin Braun</td>
                        <td>10</td>
                        <td>60</td>
                        <td>2</td>
                        <td>1 Srv + 60 CAL</td>
                        <td>0</td>
                      </tr>
                      <tr>
                        <td className="sub-name">Henkell Freixenet</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                        <td>0</td>
                      </tr>
                      <tr>
                        <td className="sub-name">OE. Hotels</td>
                        <td>3</td>
                        <td>0</td>
                        <td>10</td>
                        <td>0</td>
                        <td>0</td>
                      </tr>
                    </tbody>
                    <tfoot>
                      <tr>
                        <td className="sub-name">TOTAL</td>
                        <td>13</td>
                        <td>60</td>
                        <td>12</td>
                        <td>1 Srv + 60 CAL</td>
                        <td>2 Srv</td>
                      </tr>
                    </tfoot>
                  </table>
                </div>
                
                <div className="entitlements-note">
                  * EA = Enterprise Agreement (Core licenses) | MPSA = Microsoft Products and Services Agreement (CALs, Server licenses)
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }
    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
  
  <!-- Service Worker Registration -->
  <script>
    if ('serviceWorker' in navigator) {
      window.addEventListener('load', () => {
        navigator.serviceWorker.register('sw.js')
          .then(reg => console.log('SW registered:', reg.scope))
          .catch(err => console.log('SW registration failed:', err));
      });
    }
  </script>
</body>
</html>
